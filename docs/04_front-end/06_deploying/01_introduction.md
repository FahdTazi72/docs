---
title: 'Introduction'
sidebar_label: 'Introduction'
id: introduction
---

# Default web server setup:

For genesis application servers the web server of choice is [nginx](https://www.nginx.com/).

There is a _product user_ on each server named after the product e.g. ``priss`` on dev-hsbc-priss2. 

The web root (where the production build needs to end up) is `/data/${productUser}/web` by convention.

You can confirm that by looking at the nginx configuration file found at `/etc/nginx/conf.d/localhost.conf`

Here is what a default configuration file looks like. In this example by looking at the 5th line we can tell that:
- the _web root_ is `/data/priss/web`
- _product user_ is `priss`

```
server {

    listen 80;
    listen 8080;
    listen 443 ssl http2;
    server_name _;

    root /data/priss/web;

    index index.html index.htm;

    error_page 404 =200 /index.html;


    location /symphonyapp/ {
        rewrite                 ^/symphonyapp(.*)/$ $1 last;
        proxy_set_header       Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_set_header        HOSTNAME $remote_addr;
        proxy_pass_request_headers      on;
        proxy_pass              https://127.0.0.1:10443/;
    }

     location /bdk/ {
        rewrite                 ^/bdk(.*)/$ $1 last;
        proxy_set_header       Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_set_header        HOSTNAME $remote_addr;
        proxy_pass_request_headers      on;
        proxy_pass              https://127.0.0.1:10443/bdk/;
    }


    location ~ ^/(sm|gwf)(.*)$ {
      proxy_set_header        Host $host:$server_port;
      proxy_pass              http://127.0.0.1:9064$2$is_args$args;
      proxy_http_version      1.1;
      proxy_set_header        X-Real-IP $remote_addr;
      proxy_set_header        HOSTNAME $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header        X-Forwarded-Proto $scheme;
      proxy_pass_request_headers      on;
      proxy_set_header        Upgrade $http_upgrade;
      proxy_set_header        Connection $connection_upgrade;
    }
    location /ws/ {
      rewrite                 ^/ws(.*)/$ /$1 break;
      proxy_set_header        Host 127.0.0.1:9064;
      proxy_pass              http://localhost:9064;
      proxy_http_version      1.1;
      proxy_set_header        Upgrade $http_upgrade;
      proxy_set_header        Connection "Upgrade";
    }
    location = /console/ {
      proxy_set_header        X-Real-IP $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header        X-Forwarded-Proto $scheme;
      proxy_pass              https://genesis-portal.s3.eu-west-2.amazonaws.com/console/proxy/index.html;
    }
    location /console/ {
      proxy_set_header        X-Real-IP $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header        X-Forwarded-Proto $scheme;
      proxy_pass              https://genesis-portal.s3.eu-west-2.amazonaws.com/console/proxy/;
    }
    location /console-next/ {
      return 307 https://genesis.global/console/console-next/?host=$host&force;
    }
    ssl_certificate     /etc/ssl/certs/certs.pem;
    ssl_certificate_key /etc/ssl/certs/certs.key;
    ssl_protocols       TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;

}
```

## Manual Deployments

### To perform a manual deployment, you need to copy the web build from your machine to the target server and update the _web root_ symlink.

The files need to end up in `/data/${productUser}/web` but you often won't have access to put them there directly. To get around this you can transfer them to `/tmp` first (or any other folder with open permissions) and then copy them over to the desired location once you are logged in as the _product user_ on the server.

There are multiple ways to do this, use whichever one you are more comfortable with.

Here is an example using rsync over SSH:

- Send the files from your machine to the remote server, at first targeting the `/tmp` for permissions reasons.

```bash
rsync   -avzhP 
        -e "ssh -i /path/to/id_rsa"             # path to your ssh key
        /path/to/local/build                    # path to your local build, generated by running npm run build 
        username@remote-target:/tmp/product     # initial target folder on the server
```

- SSH into the server
    - `ssh -i /path/to/id_rsa username@remote-target`

- Switch to the product user: 
    - `sudo su - product` 

- Copy the dist files from `/tmp` to the _web root_, by convention to a folder named web-${currentdate}: 
    - `cp -r /tmp/product/www /data/product/web-20220823`

- Update the symlink:
    - `unlink /data/product/web`
    - `ln -s /data/product/web-20220823/ /data/product/web `


## Automated Deployments

Ideally an automated pipeline such as a github workflow should be put in place to *build, test and deploy* the Front End. every time the master or develop branches are updated.
It can be configured to run automatically when something is merged into certain branches or even triggered manually.

<!-- TODO: add an example that's more suitable for external clients, this one is likely only useful to our internal client app devs -->

Here is an example of a github workflow:

```yml
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: GHpages

# Manually triggered
on:
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - uses: actions/checkout@v2

      - name: Configure Node ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: https://npm.pkg.github.com/
          scope: '@genesislcap'
          
      - name: Bootstrap
        working-directory: ./client
        run: npm run bootstrap
        env:
          NODE_AUTH_TOKEN: ${{secrets.GPR_READ_TOKEN}}

      - name: Build
        working-directory: ./client/web
        run: npm run build
        env:
          NODE_AUTH_TOKEN: ${{secrets.GPR_READ_TOKEN}}

      - name: GitHub Pages action
          # You may pin to the exact commit or the version.
          # uses: peaceiris/actions-gh-pages@bbdfb200618d235585ad98e965f4aafc39b4c501
        uses: peaceiris/actions-gh-pages@v3.7.3
        with:
          publish_dir: ../client/web/dist
          github_token: ${{secrets.GITHUB_TOKEN}}
```