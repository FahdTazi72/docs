---
id: add-calculated-data
title: Add calculated data
sidebar_label: Add calculated data
sidebar_position: 4

---
At this point, we a data model that serves both the reference database and the trading database, Our trading application has  a schema for the TRADE table, and it has event handlers, data servers and request servers.

Now we want to add calculations to add posiiton-keeping. 

## Define the data schema

Start defining the fields for the position table in the file **trading_app-fields-dictionary.kts**.

The position table needs at least 5 fields:

* POSITION_ID (this can be an autogenerated sequence, so declare it as such) : STRING
* INSTRUMENT_ID : STRING
* COUNTERPARTY_ID : STRING
* QUANTITY: LONG (total number of shares)
* NOTIONAL: DOUBLE (instrument price multiplied by quantity)

![](/img/consolidator-1-nre-fields.png)

The instrument price table needs at least two fields:

* INSTRUMENT_ID : STRING
* LAST_PRICE: DOUBLE

![](/img/fields-for-the-instrument-name-table.png)

Once you have defined the fields, run the following tasks in maven:

1. **generateSysDef** 
2. **generateFields** 

This applies the new fields  to **-tables-dictionary.kts**.

## Define the position and instrument tables

NOw add the relevant indices / primary keys for each table.

position ID is pkey for position

instrument id is pkey for INSTRUMENT_PRICE table, and INSTRUMENT_ID and COUNTERPARTY_ID nonunique indices for POSITION table + unique index on INSTRUMENT_ID + COUNTERPARTY_ID (so we can do a lookup in consolidator)).

Define a **trading_app-consolidator2.xml** file inside **trading_app-config/src/main/resources/cfg** This is where you define the consolidator logic.

The consolidator needs to increase/decrease quantity for POSITION records based on TRADE table updates. It also needs to calculate the new notional.

Add a new entry to **trading_app-processes.xml** with the consolidator2 process definition.

Add a new entry to **trading_app-service-definitions.xml** with the consolidator2 details.

## Testing

Optional? Create unit test to prove consolidator is working (test that when you insert a new trade in DB, a new position record is created with the relevant data after a while). You can have a look at core framework tests for this.