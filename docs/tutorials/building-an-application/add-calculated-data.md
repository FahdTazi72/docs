---
id: add-calculated-data
title: Add calculated data
sidebar_label: Add calculated data
sidebar_position: 4

---
At this point, we have a data model that serves both the reference database and the trading database, Our trading application has  a schema for the TRADE table, and it has event handlers, data servers and request servers.

Now we want to add calculations to add position-keeping. In brief you need to:

1. Create some new fields for the position-keeping information.
2. Create a new table for displaying the information.
3. Define the logic that calculates the positions in a new consolidator file.
4. Update the system files to incorporate the new consolidator.

## 1. Define the new fields

Start defining the fields for the position table in the file **trading_app-fields-dictionary.kts**.

The POSTION table needs at least 5 fields:

* POSITION_ID (this can be an autogenerated sequence, so declare it as such) : STRING
* INSTRUMENT_ID : STRING
* COUNTERPARTY_ID : STRING
* QUANTITY: LONG (total number of shares)
* NOTIONAL: DOUBLE (instrument price multiplied by quantity)

![](/img/consolidator-1-nre-fields.png)

The instrument price table needs at least two fields:

* INSTRUMENT_ID : STRING
* LAST_PRICE: DOUBLE

![](/img/fields-for-the-instrument-name-table.png)

Once you have defined the fields, run the following tasks in maven:

1. **generateSysDef**
2. **generateFields**

This applies the new fields  to **-tables-dictionary.kts**.

## 2. Add the primary keys and indices for each table
## Add the primary keys

* POSITION_ID is the primary key  (**primaryKey**) for the POSITION table.
* instrument id is the primary key (**primaryKey**) for the INSTRUMENT_PRICE, INSTRUMENT_ID and COUNTERPARTY_ID tables.

![](/img/keys-and-indices.png)

## Add the indices 

* nonunique indices for the POSITION table
* unique index for the INSTRUMENT_ID and COUNTERPARTY_ID tables (This enables you to do a lookup in consolidator.)

## 3. Define the position-keeping logic in the consolidator

Define a **trading_app-consolidator2.xml** file inside **trading_app-config/src/main/resources/cfg**. This is where you define the consolidator logic.

The consolidator is going to increase or decrease the quantity for POSITION records, based on the TRADE table updates. It also needs to calculate the new notional.

![](/img/consolidator-logic-consolidate-positions.png)

## 4. Update the system files

### Update the processes.xml file

Add a new entry to **trading_app-processes.xml** with the consolidator2 process definition.

![](/img/add-new-process.png)

### Update the service-definitions.xml file

Add a new entry to **trading_app-service-definitions.xml** with the consolidator2 details.

![](/img/add-to-service-defininitions.png)

## Testing

Optional? Create unit test to prove consolidator is working (test that when you insert a new trade in DB, a new position record is created with the relevant data after a while). You can have a look at core framework tests for this.